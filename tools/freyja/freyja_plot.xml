<tool id="freyja_plot" name="Freyja: Visualization" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>
        of aggregated data
    </description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="biotools"/>
    <expand macro="requirements"/>
    <expand macro="version"/>
    <command detect_errors="exit_code"><![CDATA[
    #if $plot_format == 'html'
        echo '${plot_title}' > plot_title.txt &&
        echo '${plot_intro}' > plot_intro.txt &&
        freyja dash
            $tsv_aggregated
            $csv_sample_meta
            plot_title.txt
            plot_intro.txt
            --output abundances_dashboard.html
    #else if $plot_format == 'pdf'
        freyja plot
            $tsv_aggregated
            --output abundances_plot.pdf
            #if $csv_times_meta
                --times '${csv_times_meta}'
            #end if
            #if $interval == 'MS'
                --interval MS
            #else
                --interval D
                --windowsize 70
            #end if
    #else
        echo '${plot_title}' > plot_title.txt &&
        echo '${plot_intro}' > plot_intro.txt &&
        freyja dash
            $tsv_aggregated
            $csv_sample_meta
            plot_title.txt
            plot_intro.txt
            --output abundances_dashboard.html &&
        freyja plot
            $tsv_aggregated
            --output abundances_plot.pdf
            #if $csv_times_meta
                --times '${csv_times_meta}'
            #end if
            #if $interval == 'MS'
                --interval MS
            #else
                --interval D
                --windowsize 70
            #end if
    #end if
    ]]></command>
    <inputs>
            <param name="plot_format" type="select" display="checkboxes" optional="true" multiple="true" label="Choose plot format">
                <option value="html" selected="true">html</option>
                <option value="pdf">pdf</option>
            </param>
                <param name="tsv_aggregated" type="data" format="tabular" label="Provide aggregated data" />
                <param name="csv_sample_meta" type="data" format="csv" optional="true" label="Provide sample metadata file" help="Used for html format. Accepts only CSV (.csv) files" />
                <param name="plot_title" type="text" value="" optional="true" label="Title" help="Used for html format." />
                <param name="plot_intro" type="text" value="" optional="true" label="Introduction" help="Used for html format." />
                <param name="interval" type="select" label="Choose interval" display="radio" help="Used for pdf format." >
                    <option value="MS" selected="true">month bins</option>
                    <option value="D">day bins</option>
                </param>
                <param name="csv_times_meta" type="data" format="csv" optional="true" label="Provide times metadata file" help="Used for pdf format. Accepts only CSV (.csv) files" />
    </inputs>	
    <outputs>
        <!-- outputs for dash command -->
        <data name="abundances_dashboard" format="html" label="${tool.name} on ${on_string}: Lineages abundances dashboard" from_work_dir="abundances_dashboard.html">
            <filter>'html' in plot_format</filter>
        </data>
        <!-- outputs for plot command -->
        <data name="abundances_plot" format="pdf" label="${tool.name} on ${on_string}: Lineages abundances plot" from_work_dir="abundances_plot.pdf">
            <filter>'pdf' in plot_format</filter> 
        </data>
    </outputs>	
    <tests>
	    <!-- Test 01: dash command -->
        <test expect_num_outputs="1">
                <param name="plot_format" value="html"/>
                <param name="tsv_aggregated" value="bunch_of_files.tsv"/>
                <param name="csv_sample_meta" value="csv_sample_meta.csv" />
                <param name="plot_title" value="This is title" />
                <param name="plot_intro" value="Local WW Dashboard" />
            <output name="abundances_dashboard" ftype="html">
                <assert_contents>
                    <has_text text="Local WW Dashboard"/>
                </assert_contents>
            </output>
        </test>
        <!-- Test 02: plot command -->
        <test expect_num_outputs="1">
                <param name="plot_format" value="pdf"/>
                <param name="tsv_aggregated" value="bunch_of_files.tsv"/>
                <param name="csv_sample_meta" value="times_metadata.csv" />
                <param name="interval" value="D" />
            <output name="abundances_plot" ftype="pdf">
                <assert_contents>
                    <has_text text="Matplotlib"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
@HELP_HEADER@

Information about **freyja plot** method
========================================

Method provides a fractional abundance estimate for all aggregated samples.

Information about **freyja dash** method
========================================

Functionality to rapidly prepare a dashboard web page, directly from aggregated freyja output.


    ]]></help>
    <expand macro="citations"/>
</tool>
