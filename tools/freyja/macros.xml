<?xml version="1.0"?>
<macros>
    <token name="@TOOL_VERSION@">1.3.8</token>
    <token name="@VERSION_SUFFIX@">0</token>
    <token name="@PROFILE@">21.01</token>
    <xml name="biotools">
        <xrefs>
            <xref type="bio.tools">freyja</xref>
        </xrefs>
    </xml>
    <xml name="requirements">
        <requirements>
            <requirement type="package" version="@TOOL_VERSION@">freyja</requirement>
            <yield/>
        </requirements>
    </xml>
    <xml name="version">
        <version_command>freyja --version</version_command>
    </xml>
    <token name="@RUN_FREYJA_UPDATE_COMMAND@"><![CDATA[
#if $usher_update_option.choice == 'update'
    freyja update &&
#end if
]]></token>
<token name="@PREPROCESS_VCF_INPUT@"><![CDATA[
ln -s '$variants_file' 'variants_file.vcf' &&
]]></token>
    <token name="@STANDARD_INPUT_FOR_BOOT@"><![CDATA[
#if $variants_file.ext == 'vcf'
    'variants_file.vcf'
#else
    '$variants_file'
#end if
'$depth_file'
#if $eps
    --eps '${eps}'
#end if
#if $meta
    --meta '${meta}'
#end if
$confirmedonly
]]></token>
<token name="@CUSTOM_BARCODES_COMMAND@"><![CDATA[
#if $usher_update_option.choice == 'custom'
    --barcodes '${usher_update_option.usher_barcodes}'
#end if
]]></token>
<token name="@DASH_COMMAND@"><![CDATA[
echo '${plot_format.plot_title}' > plot_title.txt &&
echo '${plot_format.plot_intro}' > plot_intro.txt &&
freyja dash
    #if $need_aggregation.choice == 'no'
        '$tsv_aggregated'
    #else
        'aggregated.tsv'
    #end if
    '$plot_format.csv_meta'
    plot_title.txt
    plot_intro.txt
    --output abundances_dashboard.html
]]></token>
<token name="@PLOT_COMMAND@"><![CDATA[
freyja plot
    #if $need_aggregation.choice == 'no'
        '$tsv_aggregated'
    #else
        'aggregated.tsv'
    #end if
    --output abundances_plot.pdf
    #if $plot_format.csv_meta
        --times '${plot_format.csv_meta}'
    #end if
    #if $plot_format.interval == 'MS'
        --interval MS
    #else
        --interval D
        --windowsize 70
    #end if
]]></token>
<token name="@PLOT_AND_DASH_COMMAND@"><![CDATA[
#if $plot_format.choice == 'dash'
    @DASH_COMMAND@
#else if $plot_format.choice == 'plot'
    freyja plot
    #if $need_aggregation.choice == 'no'
        $tsv_aggregated
    #else
        aggregated.tsv
    #end if
    --output abundances_plot.pdf
    #if $plot_format.need_metadata.choice == 'yes'
        --times '${plot_format.need_metadata.csv_meta}'
        #if $plot_format.need_metadata.interval == 'MS'
            --interval MS
        #else
            --interval D
            --windowsize 70
        #end if
    #end if
#else if $plot_format.choice == 'plot_and_dash'
    @DASH_COMMAND@ &&
    @PLOT_COMMAND@
#end if
]]></token>
<token name="@DEMIX_COMMAND@"><![CDATA[
#if $input.structure == 'one_per_sample'
    #for $i, $s in enumerate($input.variants)
        #if str($i) != "0"
            &&
        #end if
        #set $varfile_number = str($i + 1)
        #set $ext = $s.variants_file.ext
        #if $s.sample_name
            #set $varfile = $s.sample_name.replace(" ","_") + '.' + $ext
        #else
            #set $varfile = $varfile_number + '.' + $ext
        #end if
        #set $abundances = 'abundances_' + $varfile + '.tsv'
        ln -s '$s.variants_file' '$varfile' &&
        freyja demix
            '$varfile'
            '$s.depth_file'
            #if $s.eps
                --eps '${s.eps}'
            #end if
            #if $s.meta
                --meta '${s.meta}'
            #end if
            $s.confirmedonly
            --output '$abundances'
            @CUSTOM_BARCODES_COMMAND@
            --covcut $s.depth_cutoff
    #end for
#else
    #set demix_dir = 'demix_inputs/'
    #set file_paths1 = []
    #set dfile_paths1 = []
    mkdir -p demix_inputs &&
    #for $i, ($s, $d) in enumerate(zip($input.variants_file, $input.depth_file))
	    #if str($i) != "0"
            &&
        #end if
        #set $file_number = str($i + 1)
        #set $file_path = $demix_dir + $file_number + '_' + $s.element_identifier
        #set $dfile_path = $demix_dir + $file_number + '_' + $d.element_identifier
        ln -s '$s' '$file_path' &&
        ln -s '$d' '$dfile_path' &&
        $file_paths1.append($file_path)
        $dfile_paths1.append($dfile_path)
        #set $abundances = 'abundances_' + $file_number + '_' + $s.element_identifier + '.tsv'
        freyja demix
            '$file_path'
            '$dfile_path'
            #if $input.eps
                --eps '${input.eps}'
            #end if
            #if $meta
                --meta '${input.meta}'
            #end if
            $input.confirmedonly
            --output '$abundances'
            @CUSTOM_BARCODES_COMMAND@
            --covcut $input.depth_cutoff
    #end for
#end if
]]></token>
    <xml name="optional_input_params_demix">
	    <param argument="--meta" type="data" format="txt" optional = "true" label="Castom lineage metadata file" help="For additional flexibility and reproducibility of analyses, a custom lineage-to-contellation mapping metadata file can be provided." />
        <param argument="--eps" type="float" optional="true" label="Minimum lineage abundance tp include" help="e.g. 0.0001." />
        <param argument="--confirmedonly" type="boolean" truevalue="--confirmedonly" falsevalue="" checked="false" label="Remove unconfirmed lineages from the analysis" help="As the UShER tree now included proposed lineages, the --confirmedonly flag removes unconfirmed lineages from the analysis." />
		<param name="depth_cutoff" argument="--covcut" type="integer" min="0" value="10"  multiple="true" label="Depth cutoff for coverage estimate" help="In the result file the coverage value will provide the 10x coverage estimate (percent of sites with 10 or greater reads- 10 is the default but can be modfied in this field. " />
	</xml>
	<xml name="input_for_demix">
        <conditional name="input">
            <param name="structure" type="select"
            label="Structure of your input data"
            help="">
                <option value="one_per_sample">One input dataset per sample</option>
                <option value="many">Multiple input datasets/collection</option>
            </param>
            <when value="one_per_sample">
                <repeat name="variants" title="Variants" min="1">
                    <param name="sample_name" type="text" value="" optional="true" label="Sample name" help="Sample name appears in the result table and will be used in the result table of 'Freyja: Aggregate and visualize' tool. If this field is not filled in, the serial number of this section will be used instead." />
                    <param name="variants_file" type="data" format="tabular" label="Variants file" />
                    <param name="depth_file" type="data" format="tabular" label="Sequencing depth file" />
                    <expand macro="optional_input_params_demix"/>
                </repeat>
            </when>
            <when value="many">
                <param name="variants_file" multiple="true" type="data" format="tabular" label="Variants file(s)" />
                <param name="depth_file" multiple="true" type="data" format="tabular" label="Sequencing depth file" />
                <expand macro="optional_input_params_demix"/>
            </when>
        </conditional>
    </xml>
	<xml name="usher_update_option">
        <conditional name="usher_update_option">
            <param name="choice" type="select" label="How do you want to update UShER barcodes?">
                <option value="repo" selected="true">Use cached data from Galaxy server (can be outdated)</option>
                <option value="custom">Provide a custom barcodes file</option>
                <!--<option value="update">Get updated versions of the curated lineage file as well as the UShER global phylogenetic tree (can cause tool to run slowly)</option>-->
            </param>
            <when value="repo" />
            <when value="custom">
                <param name="usher_barcodes" type="data" format="tabular" label="UShER barcodes file" />
            </when>
            <!--<when value="update" />-->
        </conditional>
    </xml>
    <xml name="standard_input_for_boot">
        <param name="variants_file" type="data" format="tabular" label="Variants file" />
        <param name="depth_file" type="data" format="tabular" label="Sequencing depth file" />
        <param argument="--meta" type="data" format="txt" optional = "true" label="Castom lineage metadata file" help="For additional flexibility and reproducibility of analyses, a custom lineage-to-contellation mapping metadata file can be provided." />        
        <param argument="--eps" type="float" optional="true" label="Minimum lineage abundance tp include" help="e.g. 0.0001." />
        <param argument="--confirmedonly" type="boolean" truevalue="--confirmedonly" falsevalue="" checked="false" label="Remove unconfirmed lineages from the analysis" help="As the UShER tree now included proposed lineages, the --confirmedonly flag removes unconfirmed lineages from the analysis." />
    </xml>
    <xml name="standard_input_for_plot">
        <conditional name="need_metadata">
            <param name="choice" type="select" label="Provide a sample metadata file for plotting data over time?">
                <option value="yes">Yes</option>
                <option value="no">No</option>
            </param>
            <when value="yes">
                <param name="csv_meta" type="data" format="csv" label="Provide time(s) metadata file" help="See info box below to learn more about the form of meta-file. Accepts only CSV (.csv) files" />
                <param name="interval" type="select" label="Choose interval" display="radio" help="Used for pdf format." >
                    <option value="MS" selected="true">month bins</option>
                    <option value="D">day bins</option>
                </param>
            </when>
            <when value="no" />
        </conditional>
    </xml>
    <xml name="standard_input_for_dash">
        <param name="csv_meta" type="data" format="csv" label="Provide sample(s) metadata file" help="See info box below to learn more about the form of meta-file. Accepts only CSV (.csv) files" />
        <param name="plot_title" type="text" value="" optional="true" label="Title" />
        <param name="plot_intro" type="text" value="" optional="true" label="Introduction" />
    </xml>
    <xml name="standard_input_for_plot_dash">
        <param name="csv_meta" type="data" format="csv" label="Provide sample(s)/time(s) metadata file" help="See info box below to learn more about the form of meta-file. Accepts only CSV (.csv) files" />
        <param name="plot_title" type="text" value="" optional="true" label="Title" help="Used for interactive dashboard." />
        <param name="plot_intro" type="text" value="" optional="true" label="Introduction" help="Used for interactive dashboard." />
        <param name="interval" type="select" label="Choose interval" display="radio" help="Used for pdf non-interactive plot." >
            <option value="MS" selected="true">month bins</option>
            <option value="D">day bins</option>
        </param>
    </xml>
    <token name="@HELP_HEADER@"><![CDATA[
What it does
============

Freyja is a tool to recover relative lineage abundances from mixed SARS-CoV-2 samples from a sequencing dataset (BAM aligned to the Hu-1 reference).

General information
===================

Freyja is a tool to recover relative lineage abundances from mixed SARS-CoV-2 samples from a sequencing dataset (BAM aligned to the Hu-1 reference). The method uses lineage-determining mutational "barcodes" derived from the UShER global phylogenetic tree as a basis set to solve the constrained (unit sum, non-negative) de-mixing problem.

Freyja is intended as a post-processing step after primer trimming and variant calling in iVar (Grubaugh and Gangavaparu et al., 2019). From measurements of SNV freqency and sequencing depth at each position in the genome, Freyja returns an estimate of the true lineage abundances in the sample.
]]></token>
    <xml name="citations">
        <citations>
            <citation type="doi">10.5281/zenodo.6585067</citation>
        </citations>
    </xml>
</macros>