<tool id="freyja_demix" name="Freyja: Demix" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>
        lineage abundances
    </description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="biotools"/>
    <expand macro="requirements"/>
    <expand macro="version"/>
    <command detect_errors="exit_code"><![CDATA[
@RUN_FREYJA_UPDATE_COMMAND@
@DEMIX_COMMAND@
    ]]></command>
    <inputs>
        <expand macro="usher_update_option"/>
        <expand macro="input_for_demix"/>
    </inputs>	
    <outputs>
        <collection name="abundances" type="list" label="${tool.name} on ${on_string}: Lineages abundances summary">
            <discover_datasets pattern="abundances_(?P&lt;designation&gt;.+)\.tsv" format="tabular" />
        </collection>
		<!--<data name="abundances" format="tabular" label="${tool.name} on ${on_string}: Lineages abundances summary" >
		    <discover_datasets pattern="abundances_(?P&lt;designation&gt;.+)\.tsv" format="tabular" />
        </data>-->
    </outputs>	
    <tests>
	    <!-- Test 01: input structure - individual dataset -->
        <test expect_num_outputs="1">
            <conditional name="usher_update_option">
                <param name="choice" value="repo"/>
            </conditional>
			<conditional name="input">
                <param name="structure" value="one_per_sample"/>
				<repeat name="variants">
                    <param name="sample_name" value="samplename"/>
                    <param name="variants_file" value="variants.tsv" />
                    <param name="depth_file" value="depths.tsv" />
                </repeat>
            </conditional>            
            <output_collection name="abundances" type="list" count="1"/>
        </test>
		<!-- Test 02: input structure - collection -->
		<test expect_num_outputs="1">
            <conditional name="usher_update_option">
                <param name="choice" value="repo"/>
            </conditional>
			<conditional name="input">
                <param name="structure" value="many"/>
				<param name="variants_file" value="variants.tsv" />
                <param name="depth_file" value="depths.tsv" />
            </conditional>            
            <output_collection name="abundances" type="list" count="1"/>
        </test>
    </tests>
    <help><![CDATA[
@HELP_HEADER@

Information about **freyja demix** method
=========================================

The method is for estimation lineages abundances. 

Outputs
=======

This outputs to a tsv file that includes the lineages present, their corresponding abundances, and summarization by constellation.
An example output should have the format:

========== ===================================================
           filename
summarized [('Delta', 0.65), ('Other', 0.25), ('Alpha', 0.1')] 
lineages   ['B.1.617.2' 'B.1.2' 'AY.6' 'Q.3']
abundances "[0.5 0.25 0.15 0.1]"
resid      3.14159
coverage   95.8
========== ===================================================


Where *summarized* denotes a sum of all lineage abundances in a particular WHO designation (i.e. B.1*.617.2 and AY.6 abundances are summed in the above example), otherwise they are grouped into "Other". The *lineage* array lists the identified lineages in descending order, and *abundances* contains the corresponding abundances estimates. The value of *resid* corresponds to the residual of the weighted least absolute devation problem used to estimate lineage abundances. The *coverage* value provides the 10x coverage estimate (percent of sites with 10 or greater reads- 10 is the default but can be modfied using the *--covcut* option).

    ]]></help>
    <expand macro="citations"/>
</tool>
