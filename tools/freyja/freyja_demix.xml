<tool id="freyja_demix" name="freyja demix" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>
        Estimate lineages abundances
    </description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="biotools"/>
    <expand macro="requirements"/>
    <expand macro="version"/>
    <command detect_errors="exit_code"><![CDATA[
#if $usher_update_option.choice == 'update'
    freyja update &&
#end if
ln -s $vcf_file 'vcf_file' &&
ln -s $depth_file 'depth_file' &&
freyja demix
    'vcf_file'
    'depth_file'
    --output abundances.tsv
    #if $usher_update_option.choice == 'custom'
        --barcodes '${usher_update_option.usher_barcodes}'
    #end if
    #if $depth_cutoff != '10'
        --covcut '${depth_cutoff}'
    #end if
    #if $min_abundance
        --eps '${min_abundance}'
    #end if
    #if $meta
        --meta '${meta}'
    #end if
    $confirmedonly
    ]]></command>
    <inputs>
        <conditional name="usher_update_option">
            <param name="choice" type="select" label="How you want to update UShER barcodes?">
                <option value="repo" selected="true">Use cached data from Galaxy server (can be outdated)</option>
                <option value="custom">Provide a custom barcodes file</option>
                <option value="update">Get updated versions of the curated lineage file as well as the UShER global phylogenetic tree (can cause tool to run slowly)</option>
            </param>
            <when value="repo" />
            <when value="custom">
                <param name="usher_barcodes" type="data" format="vcf,tsv" multiple="false" label="UShER barcodes file" help="Accepts CSV (.csv) files" />
            </when>
            <when value="update" />
        </conditional>
        <param name="vcf_file" type="data" format="vcf,tsv" multiple="false" label="Variants file" help="Accepts VCF (.vcf), TSV (.tsv) files" />
        <param name="depth_file" type="data" format="tsv" multiple="false" label="Sequencing depth file" help="Accepts .tsv files" />
        <param name="meta" argument="--meta" type="data" format="txt" optional = "true" label="Castom lineage metadata file" help="For additional flexibility and reproducibility of analyses, a custom lineage-to-contellation mapping metadata file can be provided. Accepts TXT (.txt) file." />
        <param name="depth_cutoff" argument="--covcut" type="integer" value="10" optional="true" label="Depth cutoff for coverage estimate" help="In the result file the coverage value will provide the 10x coverage estimate (percent of sites with 10 or greater reads- 10 is the default but can be modfied in this field. Accepts integer number." />
        <param name="min_abundance" argument="--eps" type="float" optional="true" label="Minimum lineage abundance tp include" help="e.g. 0.0001. Accepts float number." />
        <param name="confirmedonly" argument="--confirmedonly" type="boolean" truevalue="--confirmedonly" falsevalue="" checked="false" label="Remove unconfirmed lineages from the analysis" help="As the UShER tree now included proposed lineages, the --confirmedonly flag removes unconfirmed lineages from the analysis." />
    </inputs>	
    <outputs>
        <data name="abundances" format="tsv" label="${tool.name} on ${on_string}: Lineages abundances summary" from_work_dir="abundances.tsv">
        </data>
    </outputs>	
    <tests>
        <test expect_num_outputs="1">
            <param name="vcf_file" value="variants.tsv" />
            <param name="depth_file" value="depths.tsv" />
            <output name="abundances" ftype="tsv">
                <assert_contents>
                    <has_text text="summarized"/>
                    <has_text text="abundances"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
@HELP_HEADER@

General information
===================

Freyja is a tool to recover relative lineage abundances from mixed SARS-CoV-2 samples from a sequencing dataset (BAM aligned to the Hu-1 reference). The method uses lineage-determining mutational "barcodes" derived from the UShER global phylogenetic tree as a basis set to solve the constrained (unit sum, non-negative) de-mixing problem.

Freyja is intended as a post-processing step after primer trimming and variant calling in iVar (Grubaugh and Gangavaparu et al., 2019). From measurements of SNV freqency and sequencing depth at each position in the genome, Freyja returns an estimate of the true lineage abundances in the sample.

Information about **freyja demix** method
=========================================

The method is for estimation lineages abundances. 

Outputs
=======

This outputs to a tsv file that includes the lineages present, their corresponding abundances, and summarization by constellation.
An example output should have the format:

========== ===================================================
           filename
summarized [('Delta', 0.65), ('Other', 0.25), ('Alpha', 0.1')] 
lineages   ['B.1.617.2' 'B.1.2' 'AY.6' 'Q.3']
abundances "[0.5 0.25 0.15 0.1]"
resid      3.14159
coverage   95.8
========== ===================================================


Where *summarized* denotes a sum of all lineage abundances in a particular WHO designation (i.e. B.1*.617.2 and AY.6 abundances are summed in the above example), otherwise they are grouped into "Other". The *lineage* array lists the identified lineages in descending order, and *abundances* contains the corresponding abundances estimates. The value of *resid* corresponds to the residual of the weighted least absolute devation problem used to estimate lineage abundances. The *coverage* value provides the 10x coverage estimate (percent of sites with 10 or greater reads- 10 is the default but can be modfied using the *--covcut* option).

    ]]></help>
    <expand macro="citations"/>
</tool>
