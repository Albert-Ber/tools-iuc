<tool id="freyja_boot" name="freyja boot" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>
        Bootstrapping method
    </description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="biotools"/>
    <expand macro="requirements"/>
    <expand macro="version"/>
    <command detect_errors="exit_code"><![CDATA[
#if $usher_update_option.choice == 'update'
	freyja update &&
#end if
ln -s $vcf_file 'vcf_file' &&
ln -s $depth_file 'depth_file' &&
freyja boot
    'vcf_file'
    'depth_file'
    #if $nt
        --nt '${nt}'
    #end if
    #if $nb
        --nb '${nb}'
    #end if
    --output_base boot_output
    #if $usher_update_option.choice == 'custom'
        --barcodes '${usher_update_option.usher_barcodes}'
    #end if
    $boxplot_pdf
    #if $min_abundance
        --eps '${min_abundance}'
    #end if
    #if $meta
        --meta '${meta}'
    #end if
    $confirmedonly
    ]]></command>
    <inputs>
	    <conditional name="usher_update_option">
            <param name="choice" type="select" label="How you want to update UShER barcodes?">
                <option value="repo" selected="true">Use cached data from Galaxy server (can be outdated)</option>
                <option value="custom">Provide a custom barcodes file</option>
                <option value="update">Get updated versions of the curated lineage file as well as the UShER global phylogenetic tree (can cause tool to run slowly)</option>
            </param>
            <when value="repo" />
            <when value="custom">
                <param name="usher_barcodes" type="data" format="vcf,tsv" multiple="false" label="UShER barcodes file" help="Accepts CSV (.csv) files" />
            </when>
            <when value="update" />
	    </conditional>
	    <param name="vcf_file" type="data" format="vcf,tsv" multiple="false" label="Variants file" help="Accepts VCF (.vcf) files,  TSV (.tsv) files" />
	    <param name="depth_file" type="data" format="tsv" multiple="false" label="Sequencing depth file" help="Accepts .tsv files" />
	    <param name="meta" argument="--meta" type="data" format="txt" optional = "true" label="Castom lineage metadata file" help="For additional flexibility and reproducibility of analyses, a custom lineage-to-contellation mapping metadata file can be provided. Accepts TXT (.txt) file." />
	    <param name="nt" argument="--nt" type="integer" optional="true" label="Max number of cpus to use" help="Accepts integer number" />
	    <param name="nb" argument="--nb" type="integer" optional="true" label="Number of bootstraps" help="Accepts integer number" />
	    <param name="min_abundance" argument="--eps" type="float" optional="true" label="Minimum lineage abundance tp include" help="e.g. 0.0001. Accepts float number." />
	    <param name="confirmedonly" argument="--confirmedonly" type="boolean" truevalue="--confirmedonly" falsevalue="" checked="false" label="Remove unconfirmed lineages from the analysis" help="As the UShER tree now included proposed lineages, the --confirmedonly flag removes unconfirmed lineages from the analysis." />
	    <param name="boxplot_pdf" argument="--boxplot pdf" type="boolean" truevalue="--boxplot pdf" falsevalue="" checked="false" label="Generate boxplot" />
    </inputs>
    <outputs>
	    <data name="boot_lineages" format="csv" label="${tool.name} on ${on_string}: Bootstrap lineages" from_work_dir="boot_output_lineages.csv">
	    </data>
	    <data name="boot_summarized" format="csv" label="${tool.name} on ${on_string}: Bootstrap summarized" from_work_dir="boot_output_summarized.csv">
	    </data>
	    <data name="boot_lineages_plot" format="pdf" label="${tool.name} on ${on_string}: Bootstrap lineages boxplot" from_work_dir="boot_output_lineages.pdf">
	        <filter>boxplot_pdf</filter>
	    </data>
	    <data name="boot_summarized_plot" format="pdf" label="${tool.name} on ${on_string}: Bootstrap summarized boxplot" from_work_dir="boot_output_summarized.pdf"> 
	        <filter>boxplot_pdf</filter> 
        </data>
    </outputs>
    <tests>
        <test expect_num_outputs="4">
	        <param name="vcf_file" value="variants.tsv" />
	        <param name="depth_file" value="depths.tsv" />
	        <param name="nt" value="4" />
	        <param name="nb" value="10" />
	        <param name="boxplot_pdf" value="true" />
	        <output name="boot_lineages" ftype="csv">
	            <assert_contents>
	                <has_text text="B.1.617.2"/>
	            </assert_contents>
	        </output>
	        <output name="boot_summarized" ftype="csv">
	            <assert_contents>
	                <has_text text="Delta"/>
	            </assert_contents>
	        </output>
	        <output name="boot_lineages_plot" ftype="pdf">
	            <assert_contents>
	                <has_text text="Matplotlib"/>
	            </assert_contents>
	        </output>
	        <output name="boot_summarized_plot" ftype="pdf">
	            <assert_contents>
	                <has_text text="Matplotlib"/>
	            </assert_contents>
	        </output>			 
        </test>
    </tests>
    <help><![CDATA[
@HELP_HEADER@

General information
===================

Freyja is a tool to recover relative lineage abundances from mixed SARS-CoV-2 samples from a sequencing dataset (BAM aligned to the Hu-1 reference). The method uses lineage-determining mutational "barcodes" derived from the UShER global phylogenetic tree as a basis set to solve the constrained (unit sum, non-negative) de-mixing problem.

Freyja is intended as a post-processing step after primer trimming and variant calling in iVar (Grubaugh and Gangavaparu et al., 2019). From measurements of SNV freqency and sequencing depth at each position in the genome, Freyja returns an estimate of the true lineage abundances in the sample.

Information about **freyja boot** method
========================================

A fast bootstrapping method for freyja.

Outputs
=======

Bootstrapping method results:
1 - Bootstrap lineages: the 0.025, 0.05,0.25,0.5 (median),0.75, 0.95, and 0.975 percentiles for each lineage;
2 - Bootstrap summarized: WHO designated VOI/VOC

    ]]></help>
    <expand macro="citations"/>
</tool>
