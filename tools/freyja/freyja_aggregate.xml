<tool id="freyja_aggregate" name="freyja aggregate" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>
        Aggregation method
    </description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="biotools"/>
    <expand macro="requirements"/>
    <expand macro="version"/>
    <command detect_errors="exit_code"><![CDATA[
    #set demix_dir = 'demix_outputs/'
    mkdir -p demix_outputs &&
        #set file_paths1 = []
        #for $input_file in $demix_file
            #set $file_path = $demix_dir + $input_file.element_identifier
            ln -s '$input_file' '$file_path' &&
            $file_paths1.append($file_path)
        #end for
    freyja aggregate
        $demix_dir
        --output aggregated.tsv
    ]]></command>
    <inputs>
        <param name="demix_file" type="data" format="tsv,csv,txt" multiple="true" label="Lineages abundances summary file(s)" help=".tsv files recommended. E.g. one file per one sample." />
    </inputs>
    <outputs>
        <data name="aggregated" format="tsv" label="${tool.name} on ${on_string}: Aggregated data" from_work_dir="aggregated.tsv">
        </data>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <param name="demix_file" value="abundances.tsv,abundances2.tsv,abundances3.tsv,abundances4.tsv" />
            <output name="aggregated" ftype="tsv">
                <assert_contents>
                    <has_text text="summarized"/>
                    <has_text text="abundances"/>
                    <has_text text="B.1.617.2"/>
                </assert_contents>
            </output>
        </test>
    </tests>
    <help><![CDATA[
@HELP_HEADER@

General information
===================

Freyja is a tool to recover relative lineage abundances from mixed SARS-CoV-2 samples from a sequencing dataset (BAM aligned to the Hu-1 reference). The method uses lineage-determining mutational "barcodes" derived from the UShER global phylogenetic tree as a basis set to solve the constrained (unit sum, non-negative) de-mixing problem.

Freyja is intended as a post-processing step after primer trimming and variant calling in iVar (Grubaugh and Gangavaparu et al., 2019). From measurements of SNV freqency and sequencing depth at each position in the genome, Freyja returns an estimate of the true lineage abundances in the sample.

Information about **freyja aggregate** method
=============================================

Method for manipulating the "demixed" output files. 

Outputs
=======

This resulting aggregated data can analyzed directly as a tsv file, or can be visualized using freyja plot.

    ]]></help>
    <expand macro="citations"/>
</tool>
