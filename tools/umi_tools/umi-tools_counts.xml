<tool id="umi_tools_count" name="UMI-tools count" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <description>performs quantification of UMIs from BAM files</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements">
        <requirement type="package" version="4.7">sed</requirement>
    </expand>
    <command detect_errors="exit_code"><![CDATA[
#import re

ln -s '${input_bam}' 'input.bam' &&
ln -s '${input_bam.metadata.bam_index}' 'input.bam.bai' &&

umi_tools count
    -I input.bam
    @BARCODE_OPTIONS@
    @UMI_GROUPING_OPTIONS@
    @SC_OPTIONS@
    @SAMBAM_OPTIONS@
    '$wide_format_cell_counts'
#if '$advanced.random_seed' != 0:
    --random-seed='$advanced.random_seed'
#end if
    -S '$out_counts'


#if str($cond_extra.prepender) != "none":
#set $replacer = re.sub('[^\w\_]+', '_', str($input_bam.element_identifier.rsplit('.',1)[0]))
    #if str($cond_extra.prepender) == "string":
#set $replacer = str($cond_extra.custom_label)
    #end if

&& sed -i -r '1s|\b([ACGT]+)\b|'"$replacer"'_\1|g' '$out_counts'
#end if

    ]]></command>
    <inputs>
        <param name="input_bam" type="data" format="bam" label="Sorted BAM file" help="Please use the samtools sort tool to ensure a correct BAM input" />
        <expand macro="barcode_options_macro"/>
        <expand macro="umi_grouping_options_macro"/>
        <expand macro="sambam_options_macro"/>
        <expand macro="sc_options_macro"/>
        <param argument="--wide-format-cell-counts" name="wide_format_cell_counts" type="boolean" truevalue="--wide-format-cell-counts" falsevalue="" checked="true" label="Output a matrix of genes and cells, instead of a flat file" />
        <section name="advanced" title="Extra parameters" >
            <param argument="--random-seed" name="random_seed" type="integer" min="0" value="0" label="Random Seed" />
        </section>
        <conditional name="cond_extra" >
            <param name="prepender" type="select" label="Prepend a label to all column headers" help="This preserves uniqueness when merging with other files with the same headers. Note: filename must not contain a '.' character" >
                <option value="none" selected="true" >No modifications</option>
                <option value="string">Custom Label</option>
                <option value="dataset name">Dataset Name</option>
            </param>
            <when value="none"></when>
            <when value="dataset name"></when>
            <when value="string">
                <param name="custom_label" type="text" label="Label to Prepend" >
                    <sanitizer invalid_char="">
                        <valid initial="string.letters,string.digits">
                            <add value="-"/>
                            <add value="_"/>
                            <add value="."/>
                        </valid>
                    </sanitizer>
                </param>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="out_counts" format="tabular" />
    </outputs>
    <tests>
        <test><!--count_single_gene_tag:-->
            <param name="input_bam" value="chr19_gene_tags.bam" />
            <param name="random_seed" value="123456789" />
            <section name="sc">
                <param name="gene_tag" value="XF" />
                <param name="skip_tags_regex" value="^[__|Unassigned]" />
                <param name="per_cell" value="false" />
            </section>
            <conditional name="bc">
                <param name="extract_umi_method" value="umis" />
            </conditional>
            <section name="umi">
                <param name="method" value="directional" />
            </section>
            <param name="wide_format_cell_counts" value="false" />
            <output name="out_counts" value="count_single_gene_tag.tsv" />
        </test>
        <test><!--count_single_cells_gene_tag:-->
            <param name="input_bam" value="chr19_gene_tags.bam" />
            <param name="random_seed" value="123456789" />
            <section name="sc">
                <param name="gene_tag" value="XF" />
                <param name="skip_tags_regex" value="^[__|Unassigned]" />
                <param name="per_cell" value="true" />
            </section>
            <conditional name="bc">
                <param name="extract_umi_method" value="umis" />
            </conditional>
            <section name="umi">
                <param name="method" value="directional" />
            </section>
            <param name="wide_format_cell_counts" value="false" />
            <output name="out_counts" value="count_single_cells_gene_tag.tsv" />
        </test>
        <test><!--count_single_cells_wide_gene_tag:-->
            <param name="input_bam" value="chr19_gene_tags.bam" />
            <param name="random_seed" value="123456789" />
            <section name="sc">
                <param name="gene_tag" value="XF" />
                <param name="skip_tags_regex" value="^[__|Unassigned]" />
                <param name="per_cell" value="true" />
            </section>
            <conditional name="bc">
                <param name="extract_umi_method" value="umis" />
            </conditional>
            <section name="umi">
                <param name="method" value="directional" />
            </section>
            <param name="wide_format_cell_counts" value="true" />
            <output name="out_counts" value="count_single_cells_gene_tag_wide.tsv" />
        </test>
        <test><!-- count ENSDARG00000019692, with defaults -->
            <param name="input_bam" value="fc.ENSDARG00000019692.bam" />
            <section name="sc">
                <param name="gene_tag" value="XT" />
                <param name="per_cell" value="true" />
            </section>
            <section name="umi">
                <param name="method" value="unique" />
            </section>
            <output name="out_counts" value="fc.ENSDARG00000019692.counts" />
        </test>
        <test><!-- count ENSDARG00000019692, relabel string -->
            <param name="input_bam" value="fc.ENSDARG00000019692.bam" />
            <section name="sc">
                <param name="gene_tag" value="XT" />
                <param name="per_cell" value="true" />
            </section>
            <section name="umi">
                <param name="method" value="unique" />
            </section>
            <conditional name="cond_extra" >
                <param name="prepender" value="string" />
                <param name="custom_label" value="test" />
            </conditional>
            <output name="out_counts" value="fc.ENSDARG00000019692.counts.test" />
        </test>
        <test><!-- count ENSDARG00000019692, relabel filename -->
            <param name="input_bam" value="fc.ENSDARG00000019692.bam" />
            <section name="sc">
                <param name="gene_tag" value="XT" />
                <param name="per_cell" value="true" />
            </section>
            <section name="umi">
                <param name="method" value="unique" />
            </section>
            <conditional name="cond_extra" >
                <param name="prepender" value="dataset name" />
            </conditional>
            <output name="out_counts" value="fc.ENSDARG00000019692.counts.name" />
        </test>
    </tests>
    <help><![CDATA[

UMI Tools count - Count reads per gene from BAM using UMIs
----------------------------------------------------------

Purpose
-------

The purpose of this command is to count the number of reads per gene based
on the mapping co-ordinate and the UMI attached to the read.


It is assumed that the FASTQ files were processed with extract_umi.py
before mapping and thus the UMI is the last word of the read name. e.g:

@HISEQ:87:00000000_AATT

where AATT is the UMI sequeuence.

If you have used an alternative method which does not separate the
read id and UMI with a "_", such as bcl2fastq which uses ":", you can
specify the separator, or if your UMIs are encoded in a tag you can also specify this.

Note that the ``--per-gene`` option is hardcoded in ``umi_tools count``.

    ]]></help>
    <expand macro="citations" />
</tool>
